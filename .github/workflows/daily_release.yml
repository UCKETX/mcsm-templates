name: Daily Market Data Update and Release

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -U -r requirements.txt

      - name: Backup Previous Server Data
        run: |
          # å¤‡ä»½ç°æœ‰çš„server.jsonæ–‡ä»¶
          if [ -f "server.json" ]; then
            cp server.json server_previous.json
          fi

      - name: Update Database and Generate Server Data
        run: |
          echo "å¼€å§‹æ›´æ–°æ•°æ®åº“..."
          python main.py -i
          python main.py -u
          echo "ç”ŸæˆæœåŠ¡å™¨æ•°æ®..."
          python generate_market.py

      - name: Check for Changes and Generate Release Notes
        id: changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
          CHANGES_DETECTED=false
          
          # å¤‡ä»½å½“å‰æ–‡ä»¶ç”¨äºæ¯”è¾ƒ
          if [ -f "server.json" ]; then
            cp server.json server_previous.json
          fi
          
          # æ£€æŸ¥server.jsonæ˜¯å¦æœ‰å˜åŒ–
          if [ -f "server_previous.json" ] && [ -f "server.json" ]; then
            if ! cmp -s server_previous.json server.json; then
              CHANGES_DETECTED=true
              echo "æ£€æµ‹åˆ°server.jsonæ–‡ä»¶å˜åŒ–"
            fi
          elif [ -f "server.json" ]; then
            CHANGES_DETECTED=true
            echo "æ£€æµ‹åˆ°æ–°çš„server.jsonæ–‡ä»¶"
          fi
          
          # ç”Ÿæˆè¯¦ç»†çš„å˜æ›´è¯´æ˜
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "æ­£åœ¨åˆ†æå˜æ›´å†…å®¹..."
            
            # åˆ›å»ºPythonè„šæœ¬åˆ†æJSONæ–‡ä»¶å˜åŒ–
            cat > analyze_changes.py << 'EOF'
            import json
            import os
            from datetime import datetime
            
            def analyze_changes():
                changes = {
                    "new_versions": [],
                    "updated_versions": [],
                    "removed_versions": [],
                    "new_cores": [],
                    "stats": {}
                }
                
                try:
                    old_data = {}
                    if os.path.exists("server_previous.json"):
                        with open("server_previous.json", "r", encoding="utf-8") as f:
                            old_data = json.load(f)
                    
                    new_data = {}
                    if os.path.exists("server.json"):
                        with open("server.json", "r", encoding="utf-8") as f:
                            new_data = json.load(f)
                    
                    old_packages = {pkg["id"]: pkg for pkg in old_data.get("packages", [])}
                    new_packages = {pkg["id"]: pkg for pkg in new_data.get("packages", [])}
                    
                    old_cores = set()
                    new_cores = set()
                    
                    for pkg_id, pkg in old_packages.items():
                        core_type = pkg.get("languages", [""])[0] if pkg.get("languages") else ""
                        if core_type:
                            old_cores.add(core_type)
                    
                    for pkg_id, pkg in new_packages.items():
                        core_type = pkg.get("languages", [""])[0] if pkg.get("languages") else ""
                        if core_type:
                            new_cores.add(core_type)
                        
                        if pkg_id not in old_packages:
                            changes["new_versions"].append({
                                "id": pkg_id,
                                "name": pkg.get("name", ""),
                                "core": core_type,
                                "version": pkg.get("version", "")
                            })
                        elif old_packages[pkg_id] != pkg:
                            changes["updated_versions"].append({
                                "id": pkg_id,
                                "name": pkg.get("name", ""),
                                "core": core_type,
                                "version": pkg.get("version", "")
                            })
                    
                    for pkg_id, pkg in old_packages.items():
                        if pkg_id not in new_packages:
                            core_type = pkg.get("languages", [""])[0] if pkg.get("languages") else ""
                            changes["removed_versions"].append({
                                "id": pkg_id,
                                "name": pkg.get("name", ""),
                                "core": core_type,
                                "version": pkg.get("version", "")
                            })
                    
                    for core in new_cores:
                        if core not in old_cores:
                            changes["new_cores"].append(core)
                    
                    changes["stats"] = {
                        "total_packages": len(new_packages),
                        "total_cores": len(new_cores),
                        "new_count": len(changes["new_versions"]),
                        "updated_count": len(changes["updated_versions"]),
                        "removed_count": len(changes["removed_versions"])
                    }
                    
                    return changes
                
                except Exception as e:
                    print(f"åˆ†æå˜æ›´æ—¶å‡ºé”™: {e}")
                    return changes
            
            changes = analyze_changes()
            
            release_notes = []
            release_notes.append(f"# ğŸš€ MCSLæœåŠ¡å™¨æ•°æ®æ›´æ–° - {datetime.now().strftime('%Y-%m-%d')}")
            release_notes.append("")
            release_notes.append("## ğŸ“Š æ›´æ–°ç»Ÿè®¡")
            release_notes.append(f"- ğŸ“¦ æ€»åŒ…æ•°é‡: {changes['stats']['total_packages']}")
            release_notes.append(f"- ğŸ¯ æ”¯æŒæ ¸å¿ƒ: {changes['stats']['total_cores']} ç§")
            release_notes.append(f"- âœ¨ æ–°å¢ç‰ˆæœ¬: {changes['stats']['new_count']} ä¸ª")
            release_notes.append(f"- ğŸ”„ æ›´æ–°ç‰ˆæœ¬: {changes['stats']['updated_count']} ä¸ª")
            release_notes.append(f"- âŒ ç§»é™¤ç‰ˆæœ¬: {changes['stats']['removed_count']} ä¸ª")
            release_notes.append("")
            
            if changes["new_cores"]:
                release_notes.append("## ğŸ‰ æ–°å¢æ ¸å¿ƒç±»å‹")
                for core in changes["new_cores"]:
                    release_notes.append(f"- {core}")
                release_notes.append("")
            
            if changes["new_versions"]:
                release_notes.append("## âœ¨ æ–°å¢ç‰ˆæœ¬")
                core_groups = {}
                for version in changes["new_versions"]:
                    core = version["core"]
                    if core not in core_groups:
                        core_groups[core] = []
                    core_groups[core].append(version)
                
                for core, versions in core_groups.items():
                    release_notes.append(f"### {core}")
                    for version in versions[:10]:
                        release_notes.append(f"- {version['name']} ({version['version']})")
                    if len(versions) > 10:
                        release_notes.append(f"- ... è¿˜æœ‰ {len(versions) - 10} ä¸ªç‰ˆæœ¬")
                    release_notes.append("")
            
            if changes["updated_versions"]:
                release_notes.append("## ğŸ”„ æ›´æ–°ç‰ˆæœ¬")
                core_groups = {}
                for version in changes["updated_versions"]:
                    core = version["core"]
                    if core not in core_groups:
                        core_groups[core] = []
                    core_groups[core].append(version)
                
                for core, versions in core_groups.items():
                    release_notes.append(f"### {core}")
                    for version in versions[:10]:
                        release_notes.append(f"- {version['name']} ({version['version']})")
                    if len(versions) > 10:
                        release_notes.append(f"- ... è¿˜æœ‰ {len(versions) - 10} ä¸ªç‰ˆæœ¬")
                    release_notes.append("")
            
            if changes["removed_versions"]:
                release_notes.append("## âŒ ç§»é™¤ç‰ˆæœ¬")
                core_groups = {}
                for version in changes["removed_versions"]:
                    core = version["core"]
                    if core not in core_groups:
                        core_groups[core] = []
                    core_groups[core].append(version)
                
                for core, versions in core_groups.items():
                    release_notes.append(f"### {core}")
                    for version in versions[:10]:
                        release_notes.append(f"- {version['name']} ({version['version']})")
                    if len(versions) > 10:
                        release_notes.append(f"- ... è¿˜æœ‰ {len(versions) - 10} ä¸ªç‰ˆæœ¬")
                    release_notes.append("")
            
            release_notes.append("## ğŸ“‹ æ–‡ä»¶è¯´æ˜")
            release_notes.append("- `server.json`: æœåŠ¡å™¨æ ¸å¿ƒæ•°æ®")
            release_notes.append("")
            release_notes.append("---")
            release_notes.append("*æ­¤ç‰ˆæœ¬ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*")
            
            with open("release_notes.md", "w", encoding="utf-8") as f:
                f.write("\n".join(release_notes))
            
            print("å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ")
          EOF
            
            # è¿è¡ŒPythonè„šæœ¬
            python3 analyze_changes.py
          fi
          
          echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT

      - name: Create Release Tag
        if: steps.changes.outputs.changes_detected == 'true'
        id: tag
        run: |
          # ç”ŸæˆåŸºäºæ—¥æœŸçš„æ ‡ç­¾
          TAG_NAME="v$(date +'%Y.%m.%d')"
          
          # å¦‚æœåŒä¸€å¤©å·²æœ‰æ ‡ç­¾ï¼Œæ·»åŠ åºå·
          COUNTER=1
          ORIGINAL_TAG=$TAG_NAME
          while git tag -l | grep -q "^$TAG_NAME$"; do
            TAG_NAME="${ORIGINAL_TAG}-${COUNTER}"
            COUNTER=$((COUNTER + 1))
          done
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "åˆ›å»ºæ ‡ç­¾: $TAG_NAME"

      - name: Create GitHub Release
        if: steps.changes.outputs.changes_detected == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "MCSLæœåŠ¡å™¨æ•°æ® - ${{ steps.tag.outputs.tag_name }}"
          body_path: release_notes.md
          files: |
            server.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Temporary Files
        if: always()
        run: |
          rm -f server_previous.json
          rm -f release_notes.md

      - name: Summary
        if: steps.changes.outputs.changes_detected == 'true'
        run: |
          echo "âœ… æ•°æ®æ›´æ–°å®Œæˆå¹¶å·²å‘å¸ƒåˆ° Release: ${{ steps.tag.outputs.tag_name }}"
          echo "ğŸ“¦ åŒ…å«æ–‡ä»¶: server.json"
          echo "ğŸ“ å‘å¸ƒè¯´æ˜å·²è‡ªåŠ¨ç”Ÿæˆ"

      - name: No Changes Summary
        if: steps.changes.outputs.changes_detected == 'false'
        run: |
          echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "ğŸ“Š æ•°æ®å·²æ˜¯æœ€æ–°çŠ¶æ€"