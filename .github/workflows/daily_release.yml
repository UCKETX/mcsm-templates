name: Daily Market Data Update and Release

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -U -r requirements.txt

      - name: Backup Previous Server Data
        run: |
          # ä»GitHub Releasesä¸‹è½½æ—§çš„server.jsonæ–‡ä»¶è¿›è¡Œå¯¹æ¯”
          echo "æ­£åœ¨ä¸‹è½½æ—§çš„server.jsonæ–‡ä»¶..."
          if curl -L -f -s -o server_previous.json "https://github.com/UCKETX/mcsm-templates/releases/latest/download/server.json"; then
            echo "æˆåŠŸä¸‹è½½æ—§çš„server.jsonæ–‡ä»¶"
          else
            echo "æ— æ³•ä¸‹è½½æ—§çš„server.jsonæ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œæˆ–ç½‘ç»œé—®é¢˜ï¼‰"
            # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ä»¥é¿å…åç»­æ­¥éª¤å‡ºé”™
            touch server_previous.json
          fi

      - name: Initialize and Update Database
        run: |
          echo "å¼€å§‹åˆå§‹åŒ–å’Œæ›´æ–°æ•°æ®åº“..."
          python main.py -i
          python main.py -u
          echo "æ•°æ®åº“æ›´æ–°å®Œæˆ"

      - name: Start API Server
        run: |
          echo "å¯åŠ¨ API æœåŠ¡å™¨..."
          python main.py --server &
          SERVER_PID=$!
          echo "API_SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "ç­‰å¾… API æœåŠ¡å™¨å¯åŠ¨..."
          sleep 10
          echo "API æœåŠ¡å™¨å·²å¯åŠ¨ (PID: $SERVER_PID)"

      - name: Generate Server Data
        run: |
          echo "ç”ŸæˆæœåŠ¡å™¨æ•°æ®..."
          python generate_market.py
          echo "æœåŠ¡å™¨æ•°æ®ç”Ÿæˆå®Œæˆ"

      - name: Stop API Server
        if: always()
        run: |
          if [ ! -z "$API_SERVER_PID" ]; then
            echo "åœæ­¢ API æœåŠ¡å™¨ (PID: $API_SERVER_PID)..."
            kill $API_SERVER_PID || true
            echo "API æœåŠ¡å™¨å·²åœæ­¢"
          fi

      - name: Check for Changes and Generate Release Notes
        id: changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
          CHANGES_DETECTED=false
          
          # æ£€æŸ¥server.jsonæ˜¯å¦æœ‰å˜åŒ–
          if [ -f "server.json" ]; then
            if [ -s "server_previous.json" ]; then
              # server_previous.jsonå­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œè¿›è¡Œæ¯”è¾ƒ
              if ! cmp -s server_previous.json server.json; then
                CHANGES_DETECTED=true
                echo "æ£€æµ‹åˆ°server.jsonæ–‡ä»¶å˜åŒ–"
              else
                echo "server.jsonæ–‡ä»¶æ— å˜åŒ–"
              fi
            else
              # server_previous.jsonä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ä¸‹è½½å¤±è´¥ï¼‰
              CHANGES_DETECTED=true
              echo "æ£€æµ‹åˆ°æ–°çš„server.jsonæ–‡ä»¶ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–æ— æ³•è·å–æ—§ç‰ˆæœ¬ï¼‰"
            fi
          else
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°server.jsonæ–‡ä»¶"
            exit 1
          fi
          
          # ç”Ÿæˆè¯¦ç»†çš„å˜æ›´è¯´æ˜
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "æ­£åœ¨åˆ†æå˜æ›´å†…å®¹..."
            
            # ä½¿ç”¨ä»“åº“ä¸­çš„analyze_changes.pyè„šæœ¬
            python3 analyze_changes.py server_previous.json server.json
          fi
          
          echo "changes_detected=$CHANGES_DETECTED" >> $GITHUB_OUTPUT

      - name: Create Release Tag
        if: steps.changes.outputs.changes_detected == 'true'
        id: tag
        run: |
          # ç”ŸæˆåŸºäºæ—¥æœŸçš„æ ‡ç­¾
          TAG_NAME="v$(date +'%Y.%m.%d')"
          
          # å¦‚æœåŒä¸€å¤©å·²æœ‰æ ‡ç­¾ï¼Œæ·»åŠ åºå·
          COUNTER=1
          ORIGINAL_TAG=$TAG_NAME
          while git tag -l | grep -q "^$TAG_NAME$"; do
            TAG_NAME="${ORIGINAL_TAG}-${COUNTER}"
            COUNTER=$((COUNTER + 1))
          done
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "åˆ›å»ºæ ‡ç­¾: $TAG_NAME"

      - name: Create GitHub Release
        if: steps.changes.outputs.changes_detected == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: "MCSLæœåŠ¡å™¨æ•°æ® - ${{ steps.tag.outputs.tag_name }}"
          body_path: release_notes.md
          files: |
            server.json
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Temporary Files
        if: always()
        run: |
          rm -f server_previous.json
          rm -f release_notes.md

      - name: Summary
        if: steps.changes.outputs.changes_detected == 'true'
        run: |
          echo "âœ… æ•°æ®æ›´æ–°å®Œæˆå¹¶å·²å‘å¸ƒåˆ° Release: ${{ steps.tag.outputs.tag_name }}"
          echo "ğŸ“¦ åŒ…å«æ–‡ä»¶: server.json"
          echo "ğŸ“ å‘å¸ƒè¯´æ˜å·²è‡ªåŠ¨ç”Ÿæˆ"

      - name: No Changes Summary
        if: steps.changes.outputs.changes_detected == 'false'
        run: |
          echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "ğŸ“Š æ•°æ®å·²æ˜¯æœ€æ–°çŠ¶æ€"